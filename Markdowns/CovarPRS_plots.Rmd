---
title: "CovarPRS_Plots"
author: "Alec McKinlay"
date: "`r Sys.Date()`"
output:
  bookdown::pdf_document2:
    number_sections: true
header-includes:
  - \usepackage{float}
---

# Plots to accompany the write up of Covariate PRS project

\maketitle

\newpage

```{r SetUp, echo = FALSE, message=FALSE, warning=FALSE}

#Data path for proj dir
data.path <- "../../../data/PhenoPRS"
output_dir <- "../../../data/PhenoPRS/markdowns/plots_rmd"

#Set options for the fig sides
knitr::opts_chunk$set(echo = F, 
                      message=F, 
                      warning=F,
                      dev = "cairo_pdf",            
                      fig.path = paste0(output_dir, "/plots/"),          
                      fig.ext = "pdf")


#Set up and read in files
#setwd to 05_Markdowns folder


#Library 
library(tidyverse)
library(data.table)
library(readxl)
library(kableExtra)
library(ggplot2)
library(ggforestplot)
library(DataExplorer)
library(patchwork)
library(forcats)
library(makepipe)
library(tidyr)
library(ggh4x)
library(bookdown)
library(data.tree)   
library(ape)        
library(ggtree) 
library(xtable)

#Also load in path to scratch, proj_dir and fgfp data
source("../../parameters/base_dir.R")

#Load the data in, incase we use this
load(file.path(data.path, "data_out/fgfpdata4prs.RData"))

#Now load the data
load(file.path(data.path, "data_out/data_Reg03.1.RData"))

#Now load the data
load(file.path(data.path, "data_out/data_ConsistentAssoc03.2.RData"))

#Read in excel spread sheet with covariates
gwas_ref <- read.csv(file.path(data.path, "phenogwas_map.csv"), header = T, skip = 1)


#Need to look into uploading the GREML results

### Load in beta coefficents from the two GWAS
load(file.path(data.path, "data_out/filtered_bug_sumstats_05.1.RData"))

#Map
naming_map <- obsest_prsest %>% select(term, covar_name, term_prs, prs) %>% unique()

```

## Figure \@ref(fig:mrassump): Mendelian Randomisation Assumptions

```{r mrassump, out.height="20%", out.width="90%", fig.align='center', fig.cap="For an MR estimand to be valid its three core assumptions should hold: 1. The genetic instrument must be associated with the exposure of interest. 2. There must be no confounding of the instrument and the outcome. 3. The genetic instrument must only affect the outcome through the exposure of interest."}
# Figure 1: MR imported as PNG
knitr::include_graphics(file.path(data.path, "markdowns/figs/MR_assump.png"))
```

\newpage

## Figure \@ref(fig:DAGs): Proposed DAGs for Microbiome IVs in Causal Inference

```{r DAGs, out.height="40%", out.width="90%", fig.align='center', fig.cap="DAGs of hypothesised relationships connecting the human genome, gut microbiome traits and microbiome covariables. (i) proposes vertical pleiotropy, the pleitropic mechnism required for MR estimates to be valid. Here we have depicted the heritable covariate as upstream of the microbiome trait, but could well be represented as the other way round. Other DAGs have been proposed where our Microbiome MR would no longer be valid, including misspecification of our primary phenotype (ii), heritable confounding (iii) and the microbiome trait upstream of our outcome (iv). Many other DAGs not presented would also bias our MR estimation."}
# Figure 1: DAGs imported as PDF
knitr::include_graphics(file.path(data.path, "markdowns/figs/DAGs.pdf"))
```

\newpage

## Figure \@ref(fig:method): Methodological Overview of analysis pipeline \\

```{r method, out.height="80%", out.width="90%", fig.align='center', fig.cap="Methodological overview of the analysis pipeline. The analysis is aiming to uncover associations between the human genome and gut microbiome through microbiome covariates of interest. Once the microbiome covariates of interest have been generated, the pipeline consists of three main stages. The first is using individual-level data to regress our measured covariates onto the measured microbiome traits (beta1), regressing polygenic predictors of our covariates onto the same microbiome traits (beta2), and using GREML to estimate Rg between our covariates and microbiome traits (Rg). Next, by using summary statistics from our covariate and microbiome trait GWASs we plan to replicate inital findings from the individual level data, using both summary-level data of our FGFP cohort (beta3) and an independent subset of the MiBioGen cohort (beta4). Finally, using our results, we further annotate SNP signals from the full published MiBioGen results."}
knitr::include_graphics(file.path(data.path, "markdowns/figs/Method_Overview2.pdf"))
```


\newpage

## Table \@ref(tab:prsr2): Summary of the human covariates used for our analysis pipeline

```{r prsr2}

table1 <- filter(data4prs[["r2ofcovars"]], p.value < 0.05 & `partial_r2(m)[prs]` > 0.01) %>% merge(naming_map, by.x = "term", by.y = "term_prs", all.x = T) %>% 
  select(covar_name, `partial_r2(m)[prs]`, p.value) %>% arrange(covar_name)

colnames(table1) <- c("Covariate", "Parital R2", "pval")

formatted_table <- table1 %>%
  mutate(across(where(is.numeric), ~ signif(.x, 2)))

#Make final column in scientific notation
formatted_table <- formatted_table %>%
  mutate(`pval` = formatC(`pval`, format = "e", digits = 2))

#Display table
formatted_table %>% kbl(caption = "Heritable Covariates selected for our analysis pipeline, along with partial R2 and p-value of beta coefficient from regression of the PRS on the measured phenotype in FGFP. Covariates were selected if the its generated PRS had a p-value < 0.05 and a partial R2 > 0.01 from the regression of the PRS on the measured phenotype in FGFP.") %>% 
  kable_styling(latex_options = c("hold_position", "scale_down"), font_size = 15) %>%
  row_spec(0, bold = TRUE, font_size = 15)

  #Save this as a table for latex
print(xtable(formatted_table, digits = c(0,0,3,0)), file = file.path(data.path, "markdowns/table/covars.tex"),
      type = "latex",
      include.rownames = FALSE, 
      floating = F, #This is so can easily call upon the table in Latex
      booktabs = T) 



```

\newpage

## Figure \@ref(fig:obsheat): Heat Map of observational associations between microbiome traits and covariates of interest in FGFP


```{r obsheat, out.height="80%", out.width="90%", fig.width=15, fig.height=15, fig.align='center', fig.cap="Results from observational association between selected heritable covariates and gut microbiome data in FGFP, visualised as a heat map. The boxes are coloured in if there was evidence of observational signal (p-value < 0.05). If the covariate and microbiome trait are positively correlated the box has been coloured in green, where if an negative relationship is observed the box has been coloured purple. The x axis has been ordered by the heritable covariate with the most observational signal to least."}
#Make factor so levels don't change
obs_est$group <- factor(obs_est$group, levels = unique(obs_est$group))
obs_est$mt_clean <- gsub("_RNTRes", "", obs_est$mt)

#Covar_name for Alanine_aminotransferase is spelt Alannine_aminotransferase, fix
obs_est$covar_name <- gsub("Alannine_aminotransferase", "Alanine_aminotransferase", obs_est$covar_name)

### Heat Map

# Assuming obs_est is your dataframe and has columns: term, mt, p.value, group
obs_est %>%
  # Compute FDR-adjusted p-values using Benjamini-Hochberg method
  mutate(p_fdr = p.adjust(p.value, method = "fdr")) %>%

  # Define significance categories:
  # 0 = no evidence
  # 1 = weak positive evidence
  # 2 = weak negative evidence
  # 3 = strong positive evidence (FDR < 0.05)
  # 4 = strong negative evidence (FDR < 0.05)
  mutate(sig = case_when(
    p_fdr < 0.05 & estimate > 0 ~ 3,
    p_fdr < 0.05 & estimate < 0 ~ 4,
    p.value < 0.05 & estimate > 0 ~ 1,
    p.value < 0.05 & estimate < 0 ~ 2,
    TRUE ~ 0
  )) %>%

  # Reorder the x-axis based on number of nominally significant results
  group_by(covar_name) %>%
  mutate(sig_count = sum(p.value < 0.05)) %>%
  ungroup() %>%
  mutate(covar_name = reorder(covar_name, -sig_count)) %>%

  # Plot heatmap
  ggplot(aes(x = covar_name, y = mt_clean, fill = factor(sig))) +
  geom_tile(color = "grey80", linewidth = 0.5) +
  
  # Set custom fill colors and legend labels
  scale_fill_manual(
    values = c(
      "0" = "white",
      "1" = "lightgreen",   # Weak positive
      "2" = "lightblue",    # Weak negative
      "3" = "darkgreen",    # Strong positive
      "4" = "darkblue"        # Strong negative
    ),
    name = NULL,
    labels = c(
      "0" = "No Signal",
      "1" = "Suggestive Positive Association",
      "2" = "Weak Negative Assocaition",
      "3" = "Strong Positive Association",
      "4" = "Strong Negative Association"
    ),
  guide = guide_legend(
    nrow = 2,      # number of rows
    ncol = 3,      # number of columns (optional)
    byrow = TRUE  # fill by row first
  )
  ) +
  
  facet_grid(group ~ ., scales = "free", space = "free") +
  #scale_y_discrete(expand = expansion(mult = c(0.02, 0.1))) +
  labs(x = "Covariate", y = "Microbiome Traits") +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 16, face = "bold"),
    axis.text.y = element_text(size = 12, margin = margin(t = 2, b = 2, unit = "pt")),
    axis.title = element_text(size = 13, face = "bold"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    strip.text.y = element_text(size = 16, face = "bold", angle = 0),
    panel.grid = element_blank(),
    legend.margin = margin(t = 0, r = 20, b = 0, l = 20),
    #Make text in legend larger
    legend.text = element_text(size = 16),
    #Move legend to below the text
    legend.position = "top",
    #legend.direction = "vertical",
    #legend.box = "vertical"  
  )

#Determine how many associations for each group reached FDR corrected p-value
obs_est %>%
  mutate(p_fdr = p.adjust(p.value, method = "fdr")) %>%
  filter(p_fdr < 0.05) %>%
  group_by(covar_name) %>%
  summarise(n = n()) %>%
  arrange(desc(n))

```

\newpage

## Figure \@ref(fig:obsbar): Number of observational associations (p < 0.05) from observational regressions in FGFP split and ordered by covariate

```{r obsbar, out.height="60%", out.width="90%", fig.align='center', fig.cap="Results from observational association between selected heritable covariates and gut microbiome data in FGFP, visualised by a barchart to give an overview of the number of suggestive associations split by covariate."}
# Bar chart
###############
# Assuming obs_est has columns: covar_name, mt, p.value, group
obs_est %>%
  # Create a binary variable for significance (1 = significant, 0 = not significant)
  mutate(sig = ifelse(p.value < 0.05, 1, 0)) %>%
  
  # Group by covariate and significance, then count the number of results in each group
  group_by(covar_name, sig) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  
  # Reorder the x-axis (covar_name) based on the total number of significant results (descending)
  group_by(covar_name) %>%
  mutate(total_sig = sum(ifelse(sig == 1, count, 0))) %>%
  ungroup() %>%
  mutate(covar_name = reorder(covar_name, -total_sig)) %>%
  
  # Create the bar plot
  ggplot(aes(x = covar_name, y = count, fill = factor(sig))) +
  geom_bar(stat = "identity", position = "dodge", color = "black", size = 0.3) +  # Dodged bar chart
  
  # Define the color scale for significant vs non-significant bars
  scale_fill_manual(values = c("0" = "lightgray", "1" = "blue"), 
                    labels = c("No Signal", "Signal (p < 0.05)"), 
                    name = "Association") +
  
  # Add labels and titles
  labs(
       x = "Covariate",
       y = "Count of Microbiome Outcomes") +
  
  # Improve theme aesthetics
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 11),  # Tilt x-axis labels
    axis.text.y = element_text(size = 11),  # Larger y-axis labels
    axis.title = element_text(size = 13, face = "bold"),  # Bold axis titles
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),  # Center and bold title
    legend.position = "top"  # Move legend to top for better layout
  )

```

\newpage

## Figure \@ref(fig:prsheat): Heat map visualising beta directionality agreement between the bbservational and PRS regressions for those with suggestive signal from observational analysis


```{r prsheat, out.height="80%", out.width="90%", fig.width=15, fig.height=15, fig.align='center', fig.cap="Heat map of the agreement of the PRS and observational analysis in FGFP, any coloured box represets a regression with observational signal as suggested by our first set of regressions.  If the box is coloured in green, the beta directionality is in agreement between the observational and PRS estimate and disagreement if coloured in red."}
# Lets revisit our heatmap, but this time with observational agreeement
#Make factor so levels don't change
obsest_prsest$group <- factor(obsest_prsest$group, levels = levels(obs_est$group))
obsest_prsest$mt_clean <- gsub("_RNTRes", "", obsest_prsest$mt)

#Again fix the same error with alanine
obsest_prsest$covar_name <- gsub("Alannine_aminotransferase", "Alanine_aminotransferase", obsest_prsest$covar_name)

obsest_prsest %>%
  # Create a 4-group classification for signal agreement
  mutate(sig = case_when(
    p.value_obs >= 0.05 ~ "No_Obs_Signal",
    p.value_prs >= 0.05 ~ "No_PRS_Signal",
    sign(estimate_obs) == sign(estimate_prs) ~ "Beta_Agree",
    TRUE ~ "Beta_Disagree"
  )) %>%

  # Reorder covariates by number of non-null observational results
  group_by(covar_name) %>%
  mutate(sig_count = sum(sig != "No_Obs_Signal")) %>%
  ungroup() %>%
  mutate(covar_name = reorder(covar_name, -sig_count)) %>%

  # Create heatmap
  ggplot(aes(x = covar_name, y = mt_clean, fill = sig)) +
  geom_tile(color = "grey80", size = 0.5) +

  # Define colors and legend labels
  scale_fill_manual(
    values = c(
      "No_Obs_Signal" = "white",
      "No_PRS_Signal" = "lightyellow",
      "Beta_Disagree" = "red",
      "Beta_Agree" = "darkgreen"
    ),
    name = "Signal Agreement",
    labels = c(
      "No_Obs_Signal" = "No Observational Signal (p ≥ 0.05)",
      "No_PRS_Signal" = "No PRS Signal (p ≥ 0.05)",
      "Beta_Disagree" = "PRS & Obs Beta Disagree",
      "Beta_Agree" = "PRS & Obs Beta Agree"
    )
  ) +

  facet_grid(group ~ ., scales = "free", space = "free") +
  labs(
    x = "Covariate",
    y = "Microbiome Traits"
  ) +

  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 11),
    axis.text.y = element_text(size = 11),
    axis.title = element_text(size = 13, face = "bold"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    strip.text.y = element_text(size = 12, face = "bold", angle = 0),
    panel.grid = element_blank()
  )

#How many PRS regressions have FDR correct p-value association?
obsest_prsest %>%
  filter(p.value_obs < 0.05) %>%
  summarise(n = n(),
            n_fdr = sum(p.adjust(p.value_prs, method = "fdr") < 0.05),
            n_agree = sum(sign(estimate_obs) == sign(estimate_prs) & p.value_prs < 0.05),
            n_disagree = sum(sign(estimate_obs) != sign(estimate_prs) & p.value_prs < 0.05))


```

\newpage

## Figure \@ref(fig:prsbar): Bar chart visualising agreement vs disagreement of beta directionality as counts split by covariate

```{r prsbar, out.height="60%", out.width="90%", fig.align='center', fig.cap="Barchart of the agreeement / disagreement between out observational and PRS regressions for those estimates with observational signal. This global measure of agree vs disagree split has been ordered by covariable with the largest number of observational signal."}
## Lets also make a bar chart so we can see results of this more clearly
obsest_prsest %>%
  # Classify into 4 groups
  mutate(sig = case_when(
    p.value_obs >= 0.05 ~ "No_Obs_Signal",
    p.value_prs >= 0.05 ~ "No_PRS_Signal",
    sign(estimate_obs) == sign(estimate_prs) ~ "Beta_Agree",
    TRUE ~ "Beta_Disagree"
  )) %>%

  # Remove 'No_Obs_Signal' group
  filter(sig != "No_Obs_Signal") %>%

  # Count outcomes
  count(covar_name, sig, name = "count") %>%
  tidyr::complete(
    covar_name,
    sig = c("No_PRS_Signal", "Beta_Agree", "Beta_Disagree"),
    fill = list(count = 0)
  ) %>%

  # Reorder covariates by total signal count
  group_by(covar_name) %>%
  mutate(total_sig = sum(count)) %>%
  ungroup() %>%
  mutate(covar_name = reorder(covar_name, -total_sig)) %>%

  # Plot
  ggplot(aes(x = covar_name, y = count, fill = sig)) +
  geom_bar(stat = "identity", position = "dodge", color = "black", size = 0.3) +

  # Updated color scale (3 groups only)
  scale_fill_manual(
    values = c(
      "No_PRS_Signal" = "lightblue",
      "Beta_Disagree" = "red",
      "Beta_Agree" = "darkgreen"
    ),
    labels = c(
      "No_PRS_Signal" = "No PRS Signal",
      "Beta_Disagree" = "Beta Disagree",
      "Beta_Agree" = "Beta Agree"
    ),
    name = "PRS Association"
  ) +

  labs(
    x = "Covariate",
    y = "Count of Microbiome Outcomes"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 11),
    axis.text.y = element_text(size = 11),
    axis.title = element_text(size = 13, face = "bold"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 11)
  )


#Out of interest how many genetic regression reached an FDR adjusted p-value of significance?
obsest_prsest %>%
  filter(p.value_obs < 0.05) %>%
  summarise(n = n(),
            n_fdr = sum(p.adjust(p.value_prs, method = "fdr") < 0.05),
            n_agree = sum(sign(estimate_obs) == sign(estimate_prs) & p.value_prs < 0.05),
            n_disagree = sum(sign(estimate_obs) != sign(estimate_prs) & p.value_prs < 0.05))

```


\newpage

## Figure \@ref(fig:forest): Forest plot of beta coefficents for those bivariate covariate-micorbiome relationships with strong evidence of observational and PRS signal


```{r forest, fig.width=8, fig.height=12, fig.align='center', fig.cap="Forest plot of the beta coefficents and 95%CI from the PRS and observational regressions where we had strong evidence of signal from the set of regressions. Strong evidence was determined by pval < 0.05 for both regressions and an agreement in beta directionality. This gave us our candidate bivariate relationships for downstream interrogation"}
# Make a forest plot of the candidiate_bugs
#We can also look at those with sig observational results

#Make mt_clean
candidate_bugs$mt_clean <- gsub("_RNTRes", "", candidate_bugs$mt)

#Fix alanine
candidate_bugs$covar_name <- gsub("Alannine_aminotransferase", "Alanine_aminotransferase", candidate_bugs$covar_name)

#First reshape the data
obsest_prsest_long <- candidate_bugs %>%
  pivot_longer(cols = c(estimate_obs, estimate_prs), 
               names_to = "type", 
               values_to = "estimate") %>%
  pivot_longer(cols = c(std.error_obs, std.error_prs), 
               names_to = "error_type", 
               values_to = "std.error") %>%
  pivot_longer(cols = c(p.value_obs, p.value_prs), 
               names_to = "p_value_type", 
               values_to = "p.value") %>%
  filter((type == "estimate_obs" & error_type == "std.error_obs" & p_value_type == "p.value_obs") |
         (type == "estimate_prs" & error_type == "std.error_prs" & p_value_type == "p.value_prs")) %>%
  mutate(type = recode(type, estimate_obs = "FGFP_Phenotypic_Regression", estimate_prs = "FGFP_PRS_Regression"))


#Forest plot for the observational and PRS estimate
ggforestplot::forestplot(
  df = obsest_prsest_long,
  name = mt_clean,
  estimate = estimate,
  se = std.error,
  pvalue = p.value,
  colour = type,
  xlab = "Standardised Effect Estimate (95% CI) ",
  ylab = "Gut Microbiome Trait") +
  ggforce::facet_col(
    facets = ~covar_name,
    scales = "free_y"
  ) +
  labs(colour = "Regression Type") +
  # Apply theme adjustments
 theme_classic() +
  theme(
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 10),
    strip.text = element_text(size = 12, face = "bold"),
    plot.margin = unit(c(1, 1, 1, 1), "lines"),
    panel.grid.major.y = element_line(color = "grey90"),
    panel.grid.minor = element_blank(),
    legend.position = "top",
    legend.title = element_text(size = 12)
  )

# Split your covariates into two groups
covars <- unique(obsest_prsest_long$covar_name)
group1 <- covars[1:ceiling(length(covars)/2)]
group2 <- covars[(ceiling(length(covars)/2)+1):length(covars)]

# Plot 1
p1 <- ggforestplot::forestplot(
  df = obsest_prsest_long %>% filter(covar_name %in% group1),
  name = mt_clean,
  estimate = estimate,
  se = std.error,
  pvalue = p.value,
  colour = type,
  xlab = "Standardised Effect Estimate (95% CI)",
  #ylab = "Gut Microbiome Trait"
) +
  ggforce::facet_col(facets = ~covar_name, scales = "free_y") +
  labs(colour = "Regression Type") +
  theme_classic() +
  theme(
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 10),
    strip.text = element_text(size = 12, face = "bold"),
    plot.margin = unit(c(1, 1, 1, 1), "lines"),
    panel.grid.major.y = element_line(color = "grey90"),
    panel.grid.minor = element_blank(),
   legend.position = "top",        # Move legend to top
  legend.direction = "horizontal",# Arrange items horizontally
  legend.title = element_text(size = 12, face = "bold"),
  legend.text = element_text(size = 10),
  legend.key.size = unit(0.5, "cm") # Reduce the size of legend boxes

  )

# Plot 2
p2 <- ggforestplot::forestplot(
  df = obsest_prsest_long %>% filter(covar_name %in% group2),
  name = mt_clean,
  estimate = estimate,
  se = std.error,
  pvalue = p.value,
  colour = type,
  xlab = "Standardised Effect Estimate (95% CI)",
  #ylab = "Gut Microbiome Trait"
) +
  ggforce::facet_col(facets = ~covar_name, scales = "free_y") +
  labs(colour = "Regression Type") +
  theme_classic() +
  theme(
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 10),
    strip.text = element_text(size = 12, face = "bold"),
    plot.margin = unit(c(1, 1, 1, 1), "lines"),
    panel.grid.major.y = element_line(color = "grey90"),
    panel.grid.minor = element_blank(),
   legend.position = "top",        # Move legend to top
  legend.direction = "horizontal",# Arrange items horizontally
  legend.title = element_text(size = 12, face = "bold"),
  legend.text = element_text(size = 10),
  legend.key.size = unit(0.5, "cm") # Reduce the size of legend boxes
  )

p1 + p2 + plot_layout(guides = "collect") & theme(legend.position = "top")

#Save this 12 by 8 landscape in figures folder
ggsave(filename = file.path(output_dir, "plots/Forest_Plot_Candidate_Bugs.pdf"),
       width = 12,
       height = 8,
       units = "in")


```

\newpage

## Table \@ref(tab:obsprs): Table of Observational and PRS regressions for those selected candidate microbiome-covariate relationships

```{r obsprs}
#We want to add a table in showing the PRS and obs results for our selected bivariate relationships
candidate_bugs %>% 
  #Add in 95%CIs for estimate_obs and estimate_prs
  mutate(ci95_obs = paste0(round(estimate_obs - 1.96 * std.error_obs, 3), ", ", round(estimate_obs + 1.96 * std.error_obs, 3)),
         ci95_prs = paste0(round(estimate_prs - 1.96 * std.error_prs, 3), ", ", round(estimate_prs + 1.96 * std.error_prs, 3))) %>%
  select(mt_clean, group, covar_name, estimate_obs, ci95_obs, p.value_obs, `nobs(lm)`, estimate_prs, ci95_prs, p.value_prs, `nobs(lm2)`) %>%
  rename(n_obs = `nobs(lm)`, n_prs = `nobs(lm2)`) %>%
  #Round to 3dp for numeric vars
  mutate(across(c(estimate_obs, estimate_prs), ~ round(., 3))) %>%
  #scientific notation for pvals to 2 decimal places
  mutate(across(c(p.value_obs, p.value_prs), ~ formatC(., format = "e", digits = 2))) %>%
  arrange(covar_name)   %>%
  kbl(caption = "Estimates and p-values for observational and PRS regressiom for those bivariate microbiome-covariate relationships with p < 0.05 for both regressions and directionality agreement") %>% 
  kable_styling(latex_options = c("hold_position", "scale_down"), font_size = 20) %>%
  row_spec(0, bold = TRUE, font_size = 15)

#Output this table in latex format
print(xtable(candidate_bugs %>% 
                #Add in 95%CIs for estimate_obs and estimate_prs
                mutate(ci95_obs = paste0(round(estimate_obs - 1.96 * std.error_obs, 3), ", ", round(estimate_obs + 1.96 * std.error_obs, 3)),
                       ci95_prs = paste0(round(estimate_prs - 1.96 * std.error_prs, 3), ", ", round(estimate_prs + 1.96 * std.error_prs, 3))) %>%
                select(mt_clean, group, covar_name, estimate_obs, ci95_obs, p.value_obs, `nobs(lm)`, estimate_prs, ci95_prs, p.value_prs, `nobs(lm2)`) %>%
                rename(n_obs = `nobs(lm)`, n_prs = `nobs(lm2)`) %>%
                #Round to 3dp for numeric vars
                mutate(across(c(estimate_obs, estimate_prs), ~ round(., 3))) %>%
                #scientific notation for pvals to 2 decimal places
                mutate(across(c(p.value_obs, p.value_prs), ~ formatC(., format = "e", digits = 2))) %>%
                arrange(covar_name), 
              digits = 3), 
      file = file.path(data.path, "markdowns/table/obs_prs_results.tex"),
      type = "latex",
      include.rownames = FALSE, 
      floating = F, #This is so can easily call upon the table in Latex
      booktabs = T)

# Custom function for xtable
sanitize_custom <- function(x) {
  # Only escape _ for non-math strings
  sapply(x, function(val) {
    if (is.na(val)) return(NA_character_)
    val <- as.character(val)
    # Detect if it contains $ (math mode), skip escaping
    if (grepl("\\$", val)) {
      return(val)
    } else {
      # Escape underscores
      gsub("_", "\\\\_", val)
    }
  })
}


print(
  xtable(
    candidate_bugs %>%
      # Add in 95%CIs for estimate_obs and estimate_prs
      mutate(
        ci95_obs = paste0(
          round(estimate_obs - 1.96 * std.error_obs, 3), ", ",
          round(estimate_obs + 1.96 * std.error_obs, 3)
        ),
        ci95_prs = paste0(
          round(estimate_prs - 1.96 * std.error_prs, 3), ", ",
          round(estimate_prs + 1.96 * std.error_prs, 3)
        )
      ) %>%
      select(
        mt_clean, group, covar_name,
        estimate_obs, ci95_obs, p.value_obs, `nobs(lm)`,
        estimate_prs, ci95_prs, p.value_prs, `nobs(lm2)`
      ) %>%
      rename(n_obs = `nobs(lm)`, n_prs = `nobs(lm2)`) %>%
      # Round to 3dp for numeric vars
      mutate(across(c(estimate_obs, estimate_prs), ~ round(., 3))) %>%
      # Format p-values in LaTeX math mode: 1.2 × 10^{-3}
     mutate(across(
        c(p.value_obs, p.value_prs),
        ~ ifelse(
          is.na(.),
          NA_character_,
          ifelse(
            . < 0.001,
            paste0(
              "$",
              gsub(
                "e\\+?(-?)([0-9]+)",
                " \\\\times 10^{\\1\\2}",
                formatC(., format = "e", digits = 2)
              ),
              "$"
            ),
            as.character(round(., 3))
          )
        )
      ))
    %>%
      arrange(covar_name),
    digits = 3
  ),
  file = file.path(data.path, "markdowns/table/obs_prs_results.tex"),
  type = "latex",
  include.rownames = FALSE,
  floating = FALSE,
  booktabs = TRUE,
  sanitize.text.function = sanitize_custom
)



```


```{r}
#This is the block of code which is for the Fig9 block of code. We still want this part to run so have added to a different code block

load(file = file.path(data.path, "data_out/BetaCor_05.3.RData"))

beta_cor <- mutate(lm_out,
                   mt = paste0(bug, "Res")) %>%
  merge(unique(obsest_prsest_long[,c("term", "mt", "group", "prs", "covar_name")]), 
        by.x = c("covar", "mt") ,
        by.y = c("prs", "mt")) %>% 
  select(-term.x) %>%
  rename(term = term.y) %>%
  mutate(type = "FGFP_BetaGWAS_Cor")
        
#Plot with PRS and Observational
obsest_prest_betacor_long <- bind_rows(obsest_prsest_long, beta_cor)
```

##  Table \@ref(tab:fullnametable): Full classification of our microbiome traits of interest

```{r fullnametable}
load(file.path(data.path, "data_out/BetaCorMBG_05.4.RData"))

#Add in the covar names to these regression results
lm_out_mbg <- lm_out_mbg %>% select(-term) %>%
  merge(naming_map, 
  by.x = "covar", 
  by.y = "prs", 
  all.x = T)
  
lm_out_mbg %>%
select(covar_name, TaxaName, Phylum, Class, Order, Family, Genus, mbgbugs) %>%
  arrange(covar_name) %>% 
  kbl(caption = "Full Taxonomic Names of our microbiome traits of interest") %>% 
  kable_styling(latex_options = c("hold_position", "scale_down"), font_size = 20) %>%
  row_spec(0, bold = TRUE, font_size = 15)

```

```{r}
#We want to make some taxonomic rank plots
taxonomy_df <- lm_out_mbg %>%
  select(Phylum, Class, Order, Family, Genus, TaxaName) %>%
  mutate(across(where(is.character), ~ na_if(., "NA"))) %>%
  distinct() %>%
  #Remove if Phylum:Genus is NA
  filter(!(is.na(Phylum) & is.na(Class) & is.na(Order) & is.na(Family) & is.na(Genus)))


#Fix the unclassified errors in the dataframe
unclas <- taxonomy_df$TaxaName[grepl("unclassified", taxonomy_df$TaxaName)]

#If TaxaName is unclassified, set all NA taxonomic levels to "unclassified"
taxonomy_df <- taxonomy_df %>%
  mutate(across(c(Phylum, Class, Order, Family, Genus), 
                ~ ifelse(TaxaName %in% unclas & is.na(.), "Unclassified", .))) %>%
  #Filter if Genus is NA
  filter(!is.na(Genus))

taxonomy_df$pathString <- apply(taxonomy_df, 1, function(x) paste(c("Root", x), collapse = "/"))
tax_tree <- as.Node(taxonomy_df)

phylo_tree <- as.phylo(tax_tree)

# Plot the tree with ggtree
p <- ggtree(phylo_tree)

# Add labels to all nodes (internal + tips)
p + 
  geom_node_text(aes(label = ifelse(label == "Root" | startsWith(label, "G_"), NA, label)), 
                 hjust = -0.1, vjust = -0.5, size = 3)

#We also want to highlight G_Faecalibacterium on the plot
node_of_interest <- which(p$data$label %in% filter(taxonomy_df, TaxaName == "G_Faecalibacterium")[1:6] %>% unlist(use.names = FALSE))
highlight_nodes <- p$data[node_of_interest, ]
highlight_nodes <- highlight_nodes[!startsWith(highlight_nodes$label, "G_"), ]

p + 
  geom_node_point(data = highlight_nodes, aes(x = x, y = y), color = "red", size = 3) +
  geom_node_text(data = highlight_nodes, aes(label = label), 
                 hjust = -0.1, vjust = -0.5, size = 3, color = "red")
  
```

\newpage

## Figure \@ref(fig:fullforest): Forest plot of observational, PRS and beta coefficient correlaiton in FGFP, alongside replication of beta coefficient correlation in an independent microbiome GWAS population

```{r, fullforest, out.height="70%", out.width="90%", fig.width=15, fig.height=10, fig.align='center', fig.cap="Correlation of GWAS Beta Coefficients between our covariates and microbiome traits of interest in both FGFP and our independent microbiome GWAS sample. This is plotted alongside our intial Observational and PRS results in FGFP. "}

#Make our matched mbg_fgfp bug dataframe
mbgbugs <- c("simpson", #Div_NumGen
             "invsimpson", #Div_Chao
             "family.Lachnospiraceae.id.1987",
             "genus.Barnesiella.id.944",
             "genus.Roseburia.id.2012", 
             "family.Ruminococcaceae.id.2050", #G_Sporobacter
             "family.Ruminococcaceae.id.2050", #G_unclassified
             NA, #G_Unclassified__K_Bacteria
             "order.Clostridiales.id.1863",
             "phylum.Firmicutes.id.1672", #G_Unclassified
             "family.Erysipelotrichaceae.id.2149",
             "genus.Holdemanella.id.11393",
             "genus.Ruminococcus1.id.11373",
             "family.Erysipelotrichaceae.id.2149", #G_unclassified
             "family.Ruminococcaceae.id.2050",
             "genus.Faecalibacterium.id.2057",
             "genus.Oscillibacter.id.2063",
             "genus.Bacteroides.id.918",
             "family.Rhodospirillaceae.id.2717", #G_Aestuariispira
             "family.Lachnospiraceae.id.1987", #G_Coprococcus
             "shannon")
matched_bugs <- data.frame(fgfpbugs = unique(candidate_bugs$mt), mbgbugs = mbgbugs)

#Remove the NA
matched_bugs <- matched_bugs[!is.na(matched_bugs$mbgbugs),]

lm_out_mbg_subset <- lm_out_mbg %>%
  #Rename so we can bind to other data
  mutate(type = "MiBioGen_BetaGWAS_Cor",
         group = NA) %>%
  rename(mt = fgfpbugs) %>%
    select(covar, mbgbugs, estimate, std.error, p.value, covar_name, type, mt, term, covar_name, term_prs, group) %>%
  #Fix misspelling of alannine
  mutate(covar_name = gsub("Alannine_aminotransferase", "Alanine_aminotransferase", covar_name))
  


#Edit so can merge with other data
obsest_prest_betacor_long <- merge(obsest_prest_betacor_long,
                                   matched_bugs,
                                   by.x = "mt",
                                   by.y = "fgfpbugs",
                                   all = T)


fgfp_mbg_merged <- bind_rows(lm_out_mbg_subset,
                         select(obsest_prest_betacor_long,covar, mbgbugs, estimate, std.error, p.value, covar_name, type, mt, term, covar_name, term_prs, group)) %>%
  mutate(
    dataset = ifelse(!is.na(group), "FGFP", "MiBioGen_EURnofgfp")
  )
  
#Make mt_clean
fgfp_mbg_merged$mt_clean <- gsub("_RNTRes", "", fgfp_mbg_merged$mt)
  
#We want to remove the repeated betas for MBG bugs
fgfp_mbg_merged <- filter(fgfp_mbg_merged, !(dataset == "MiBioGen_EURnofgfp" & mt == "G_unclassified_F_Erysipelotrichaceae_RNTRes"))
fgfp_mbg_merged <- filter(fgfp_mbg_merged, !(dataset == "MiBioGen_EURnofgfp" & mt == "G_Sporobacter_RNTRes"))

#Now we can make our plots
fgfp_mbg_merged$type <- factor(fgfp_mbg_merged$type, levels = c("FGFP_Phenotypic_Regression", "FGFP_PRS_Regression", "FGFP_BetaGWAS_Cor", "MiBioGen_BetaGWAS_Cor"))
fgfp_mbg_merged$dataset <- ifelse(fgfp_mbg_merged$dataset == "MiBioGen_EURnofgfp", "MiBioGen", fgfp_mbg_merged$dataset)

ggplot(fgfp_mbg_merged, aes(x = estimate, y = mt_clean, xmin = estimate - 1.96 * std.error, xmax = estimate + 1.96 * std.error)) +
  geom_pointrange(aes(colour = type), position = position_dodge(width = 0.5))  +
  facet_grid(covar_name ~ dataset, scales = "free", space = "free", switch = "y") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
  labs(y = NULL, x = "Beta Coef from Regression",
    title = "Candidate Covariate-Microbiome Relationships"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 8),
    legend.position = "bottom",
    strip.text = element_text(size = 10, face = "bold",), # Customize facet labels
    plot.margin = unit(c(1, 4.5, 1, 1), "cm"),
    strip.text.y.left = element_text(angle = 0, hjust = 0.5), # Rotate row labels
    strip.placement = "outside",            # Place strip labels outside panels
    panel.spacing = unit(1, "lines")        # Add space between rows
  )  +
  geom_text(
    data = fgfp_mbg_merged %>% filter(dataset == unique(dataset)[1]), # Apply to only one dataset column
    aes(x = 0.42, label = mbgbugs, y = mt_clean), 
    hjust = 0, size = 3, inherit.aes = FALSE
  ) +
  coord_cartesian(clip = "off") # Ensure annotations are not clipped

#Output plot
ggsave(filename = file.path(output_dir, "plots/Full_Forest_Plot_Candidate_Bugs.pdf"),
       width = 15,
       height = 10,
       units = "in")

```

\newpage

## Table \@ref(tab:corres): Genetic correlation results for our bivariate traits of interest

```{r corres}
#Another table here showing our correlation results for our two datasources

#First merge the two beta_cors together

#Change the headings in the two dataframe results so there is no confusion when merging
estimate_cols <- c("estimate", "std.error", "statistic", "p.value")
estimate_cols_nostat <- estimate_cols[!estimate_cols %in% "statistic"]
colnames(lm_out_mbg)[colnames(lm_out_mbg) %in% c(estimate_cols, paste0("ivw_", estimate_cols))] <- paste0("mbg_", colnames(lm_out_mbg)[colnames(lm_out_mbg) %in% c(estimate_cols, paste0("ivw_", estimate_cols))])


#Do the same for FGFP
colnames(lm_out)[colnames(lm_out) %in% c(estimate_cols, paste0("ivw_", estimate_cols))] <- paste0("fgfp_", colnames(lm_out)[colnames(lm_out) %in% c(estimate_cols, paste0("ivw_", estimate_cols))])


#Now merge the two dataframes
lm_out$fgfpbugs <- paste0(lm_out$bug, "Res")
cor_beta <- merge(lm_out, lm_out_mbg, by = c("covar", "fgfpbugs"), all=T)

## Also add in our genetic cor results from GREML so these can be presented with the genetic correlations
rg <- read.table(file.path(data.path, "greml/greml_out/h2out_cor_dircons/clean_out.txt"), header=T) %>% filter(rg_se < 1) %>% 
  rename(rg_GREML = rg) 

#Add in the missing covar name for the k_bacteria FGFP microbiome trait
cor_beta[is.na(cor_beta$covar_name),c("covar_name", "term.y")] <- "BMI"

#Merge with our cor_beta
cor_beta <- merge(cor_beta, rg, by.x = c("term.y", "fgfpbugs"), by.y = c("pheno1", "pheno2"), all = T)

#Estimate Rg p-value from the se and Rg columns from GREML
cor_beta <- cor_beta %>%
  mutate(rg_p.value = 2 * pnorm(-abs(rg_GREML / rg_se )))

cor_beta$mt_clean <- gsub("_RNTRes", "", cor_beta$fgfpbugs)

#Now we can make our table
cor_beta %>%
  mutate(ci95_fgfpcor = paste0(round(fgfp_estimate - 1.96 * fgfp_std.error, 3), ", ", round(fgfp_estimate + 1.96 * fgfp_std.error, 3)),
         ci95_mbgcor = paste0(round(mbg_estimate - 1.96 * mbg_std.error, 3), ", ", round(mbg_estimate + 1.96 * mbg_std.error, 3))) %>%
  select(mt_clean, covar_name, fgfp_estimate, ci95_fgfpcor, fgfp_p.value, rg_GREML, rg_p.value, mbgbugs, mbg_estimate, ci95_mbgcor, mbg_p.value) %>%
  rename(`FGFP Beta Correlation` = fgfp_estimate,
         `MiBioGen Beta Correlation` = mbg_estimate,
         FGFP_Trait = mt_clean,
         MiBioGen_Trait = mbgbugs) %>%
  #Order by covar_name
  arrange(covar_name) %>%
  #Round to 3dp for numeric vars
  mutate(across(c(`FGFP Beta Correlation`, `MiBioGen Beta Correlation`, rg_GREML, rg_p.value), ~ round(., 3))) %>%
  #scientific notation for pvals to 2 decimal places
  mutate(across(c("fgfp_p.value", "mbg_p.value"), ~ formatC(., format = "e", digits = 2))) %>%
  kbl(caption = "Genetic correlation estimation via both correlation of GWAS Beta Coefficients for covariable SNPs between our covariates and microbiome traits using FGFP GWAS summary statistics and the independent MiBioGen summary statisitcs, along with rg estimates from individual level data in FGFP. Rgs were removed if SE > 1 or the estimate was unable to converge.") %>% 
  kable_styling(latex_options = c("hold_position", "scale_down"), font_size = 20) %>%
  row_spec(0, bold = TRUE, font_size = 15)


##Now output the results to latex format removing the MiBioGen Columns and formatting scientific notation to how was done previously
print(
  xtable(
    cor_beta %>%
      mutate(ci95_fgfpcor = paste0(
        round(fgfp_estimate - 1.96 * fgfp_std.error, 3), ", ",
        round(fgfp_estimate + 1.96 * fgfp_std.error, 3)
      ),
      ci95_mbgcor = paste0(
        round(mbg_estimate - 1.96 * mbg_std.error, 3), ", ",
        round(mbg_estimate + 1.96 * mbg_std.error, 3)
      )) %>%
      select(mt_clean, covar_name, rg_GREML, rg_p.value, fgfp_estimate, ci95_fgfpcor, fgfp_p.value) %>%
      rename(`FGFP Beta Correlation` = fgfp_estimate,
             FGFP_Trait = mt_clean) %>%
      # Order by covar_name
      arrange(covar_name) %>%
      # Round to 3dp for numeric vars
      mutate(across(c(`FGFP Beta Correlation`, rg_GREML, rg_p.value), ~ round(., 3))) %>%
      # Format p-values in LaTeX math mode: 1.2 × 10^{-3}
      mutate(across(
        c("fgfp_p.value", "rg_p.value"),
        ~ ifelse(
          is.na(.),
          NA_character_,
          ifelse(
            . < 0.001,
            paste0(
              "$",
              gsub(
                "e\\+?(-?)([0-9]+)",
                " \\\\times 10^{\\1\\2}",
                formatC(., format = "e", digits = 2)
              ),
              "$"
            ),
            as.character(round(., 3))
          )
        )
      ))
  ),
  file = file.path(data.path, "markdowns/table/genetic_correlation_results.tex"),
  type = "latex",
  include.rownames = FALSE,
  floating = FALSE,
  booktabs = TRUE,
  sanitize.text.function = sanitize_custom
)

#Now do the same with mbg cor results
print(
  xtable(
    cor_beta %>%
      mutate(ci95_mbgcor = paste0(
        round(mbg_estimate - 1.96 * mbg_std.error, 3), ", ",
        round(mbg_estimate + 1.96 * mbg_std.error, 3)
      )) %>%
      select(covar_name, mt_clean, mbgbugs, mbg_estimate, ci95_mbgcor, mbg_p.value) %>%
      rename(`MiBioGen Beta Correlation` = mbg_estimate,
             MiBioGen_Trait = mbgbugs) %>%
      # Order by covar_name
      arrange(covar_name) %>%
      # Round to 3dp for numeric vars
      mutate(across(c(`MiBioGen Beta Correlation`), ~ round(., 3))) %>%
      # Format p-values in LaTeX math mode: 1.2 × 10^{-3}
      mutate(across(
        c("mbg_p.value"),
        ~ ifelse(
          is.na(.),
          NA_character_,
          ifelse(
            . < 0.001,
            paste0(
              "$",
              gsub(
                "e\\+?(-?)([0-9]+)",
                " \\\\times 10^{\\1\\2}",
                formatC(., format = "e", digits = 2)
              ),
              "$"
            ),
            as.character(round(., 3))
          )
        )
      ))
  ),
  file = file.path(data.path, "markdowns/table/genetic_correlation_results_mbg.tex"),
  type = "latex",
  include.rownames = FALSE,
  floating = FALSE,
  booktabs = TRUE,
  sanitize.text.function = sanitize_custom
)
```

\newpage

```{r}
#We also want to add our Rg into the fgfp_mbg_merged dataframe
rg2 <- merge(rg, 
              naming_map, 
              by.x = "pheno1", 
              by.y = "term", 
              all.x = T)

rg2 <- mutate(rg2,
              covar = NA,
              mbgbugs = NA,
              estimate = rg_GREML,
              std.error = rg_se,
              p.value = NA,
              type = "GREML_Rg",
              mt = pheno2,
              term = pheno1,
              group = NA,
              dataset = "FGFP",
              mt_clean = gsub("_RNTRes", "", pheno2)) %>%
  #Remove other columns
  select(covar, mbgbugs, estimate, std.error, p.value, covar_name, type, mt, term, term_prs, group, dataset, mt_clean)

#Now we can merge the rg2 into fgfp_mbg_merged
fgfp_mbg_merged <- rbind(fgfp_mbg_merged, rg2)

#Now we can make our plots


ggplot(fgfp_mbg_merged, aes(x = estimate, y = mt_clean, xmin = estimate - 1.96 * std.error, xmax = estimate + 1.96 * std.error)) +
  geom_pointrange(aes(colour = type), position = position_dodge(width = 0.5))  +
  facet_grid(covar_name ~ dataset, scales = "free", space = "free", switch = "y") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
  labs(y = NULL, x = "Beta Coef from Regression",
    title = "Candidate Covariate-Microbiome Relationships"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 8),
    legend.position = "bottom",
    strip.text = element_text(size = 10, face = "bold",), # Customize facet labels
    plot.margin = unit(c(1, 4.5, 1, 1), "cm"),
    strip.text.y.left = element_text(angle = 0, hjust = 0.5), # Rotate row labels
    strip.placement = "outside",            # Place strip labels outside panels
    panel.spacing = unit(1, "lines")        # Add space between rows
  )  +
  geom_text(
    data = fgfp_mbg_merged %>% filter(dataset == unique(dataset)[1]), # Apply to only one dataset column
    aes(x = 0.42, label = mbgbugs, y = mt_clean), 
    hjust = 0, size = 3, inherit.aes = FALSE
  ) +
  coord_cartesian(clip = "off") # Ensure annotations are not clipped
```

## Lets look at the SNPs discovered from the all FGFP summary statistics
```{r}
#Load the results for FGFP SNP enrichment
load(file.path(data.path, "data_out/ManPlotsFGFP_05.6.RData"))
```

## Figure \@ref(fig:manplots): Manhattan plot of those MiBioGen Microbiome traits with covariate SNPs in their suggestive associations

```{r manplots, out.height="70%", out.width="90%", fig.width=10, fig.height=12, fig.align='center'}
#Make a table for the SNPs of interested in the family.Lachnospiraceae associations
load(file.path(data.path, "data_out/ManPlotsMBG_05.5.RData"))

manplot[["family.Lachnospiraceae.id.1987"]] /
manplot[["phylum.Firmicutes.id.1672"]] /
manplot[["family.Ruminococcaceae.id.2050"]] /
manplot[["genus.Faecalibacterium.id.2057"]] 
```

```{r, out.height="70%", out.width="90%", fig.width=10, fig.height=12, fig.align='center', fig.cap="Manhattan plots for all our Microbiome traits where a covariate SNP (or LD covariate SNP, R2 > 0.8) could be identified in its suggestive associations from the full MiBioGen summary statistics"}
manplot[["genus.Ruminococcus1.id.11373"]] /
manplot[["family.Erysipelotrichaceae.id.2149"]] /  
manplot[["genus.Holdemanella.id.11393"]] /
manplot[["family.Rhodospirillaceae.id.2717"]]
```

\newpage

## Table \@ref(tab:snptable): SNP data for those microbiome traits with covariate SNPs in their suggestive associations published from the full MiBioGen statistics

```{r snptable}
#Lets also add in the SNP table here

snpstofollow_dirs$clean_snpstofollow %>%
  arrange(bac) %>% select(-covar_name) %>%
  #Change covar_pval so scientific notation
  mutate(pval_covar = formatC(pval_covar, format = "e", digits = 2)) %>%
  #Round beta and SE to 2dp
  mutate(across(c(R2, beta_bug, SE_bug, beta_covar, SE_covar), ~ round(., 3))) %>%
  rename(`MBG Microbiome Trait` = bac,
         `MBG SNP` = rsID,
         pval = P.weightedSumZ,
         MBG_n = N,
         Covariate = covar_clean,
         `Covariate SNP` = SNP,
         SNP_R2 = R2,
         eff.allele_mbg = eff.allele_bug,
         SE_mbg = SE_bug,
         beta_mbg = beta_bug) %>%
  kbl(caption = " SNP data for covariate SNPs identified from our pipeline from the suggestive associations published from the full MiBioGen summary statistics") %>% 
  kable_styling(latex_options = c("hold_position", "scale_down"), font_size = 20) %>%
  row_spec(0, bold = TRUE, font_size = 15)

#Lets also add in some Forest plotds
```

\newpage

# Supplementary Tables and Figures

## Supplementary Table: Full 69 microbiome covariates with assciated GWASs

```{r}
#Read in the csv file with the full traits and the GWAS cohorts
full_traits <- read.csv(file.path(data.path, "phenogwas_map.csv"), skip = 1) 

full_traits %>%
  kbl(caption = "Full covariate traits with GWAS data") %>% 
  kable_styling(latex_options = c("hold_position", "scale_down"), font_size = 20) %>%
  row_spec(0, bold = TRUE, font_size = 15)

```

\newpage

## Supplementary Table: Full Observational and PRS results

```{r}
obsest_prsest %>%
  mutate(ci95_obs = paste0(round(estimate_obs - 1.96 * std.error_obs, 3), ", ", round(estimate_obs + 1.96 * std.error_obs, 3)),
         ci95_prs = paste0(round(estimate_prs - 1.96 * std.error_prs, 3), ", ", round(estimate_prs + 1.96 * std.error_prs, 3))) %>%
  select(mt, group, covar_name, estimate_obs, ci95_obs, p.value_obs, `nobs(lm)`, estimate_prs, ci95_prs, p.value_prs, `nobs(lm2)`) %>%
  rename(n_obs = `nobs(lm)`, n_prs = `nobs(lm2)`) %>%
  #Round to 3dp for numeric vars
  mutate(across(c(estimate_obs, estimate_prs), ~ round(., 3))) %>%
  #scientific notation for pvals to 2 decimal places
  mutate(across(c(p.value_obs, p.value_prs), ~ formatC(., format = "e", digits = 2))) %>%
  arrange(covar_name, group) %>% 
  kbl(caption = "Full Observational and PRS results for all microbiome-covariate relationships", longtable = T) %>% 
kable_styling(latex_options = c("hold_position", "scale_down", "repeat_header"), font_size = 3) %>%
row_spec(0, bold = TRUE, font_size = 3)  
```

\newpage

## Supplementary Table: IVW and OLS beta correlations results in MiBioGen

```{r}
lm_out_mbg %>%
  #Make 95%CI
  mutate(ols_ci95 = paste0(round(mbg_estimate - 1.96 * mbg_std.error, 3), ", ", round(mbg_estimate + 1.96 * mbg_std.error, 3)),
         ivw_ci95 = paste0(round(mbg_ivw_estimate - 1.96 * mbg_ivw_std.error, 3), ", ", round(mbg_ivw_estimate + 1.96 * mbg_ivw_std.error, 3)),
         across(c(mbg_estimate, mbg_p.value, mbg_ivw_estimate, mbg_ivw_p.value), ~ round(., 3))) %>%
  select(covar_name, fgfpbugs, mbgbugs, mbg_estimate, ols_ci95, mbg_p.value, mbg_ivw_estimate, ivw_ci95, mbg_ivw_p.value) %>%
  rename(`OLS Beta Correlation` = mbg_estimate,
         `OLS 95% CI` = ols_ci95,
         `OLS p-value` = mbg_p.value,
         `IVW Beta Correlation` = mbg_ivw_estimate,
         `IVW 95% CI` = ivw_ci95,
         `IVW p-value` = mbg_ivw_p.value) %>%
  arrange(covar_name) %>% 
  kbl(caption = "OLS and IVW beta correlation results for our microbiome traits of interest in MiBioGen") %>% 
  kable_styling(latex_options = c("hold_position", "scale_down"), font_size = 20) %>%
  row_spec(0, bold = TRUE, font_size = 15)
```

\newpage

## Supplementary Figure: Heritability estimates for our microbiome traits of interest, before and after adjustment of the PRS

```{r, fig.width=10, fig.height=20, fig.align='center', out.height="70%", out.width="90%", fig.cap="Heritability estimated by GREML for our microbiome traits with evidence of association with covariate from previous analysis. The heritability has been recalculated before and after adjustment of covariate PRS."}

#Now load in the heritability adjustment results
h2out <- list()
for(i in c("dircons")){
  h2out[[i]] <- read.table(file.path(data.path, paste0("greml/greml_out/h2_out/", i, "/cleanh2est.txt")), header = T, sep = "\t")
}

#First extract the bug names by removing any part of the string after "_res_" in the trait column 
h2forplot <- h2out[["dircons"]] %>%
  mutate(bug = gsub("_res_.*", "", trait),
         type = ifelse(grepl("5e.08", trait), "Adjusted", "Unadjusted"))
         
         
h2forplot <- cbind(h2forplot,
                            gsub(".*_res_", "", h2out[["dircons"]]$trait) %>% str_split("__",simplify = T) %>% 
                              as.data.frame() %>% setNames(c("covar1", "covar2", "covar3"))) %>% merge(naming_map, by.x = "covar1", by.y = "term_prs", all.x = T)

splitdf <- split(h2forplot, h2forplot$type)


#Now add in multiple adjustment
splitdf$Adjusted <- mutate(splitdf$Adjusted, covar_name = ifelse(covar2 == "", paste0(covar_name, "_Adj"), "MultipleAdj"))

splitdf$Unadjusted <- mutate(splitdf$Unadjusted, covar_name = "h2_crude")

h2forplot <- rbind(splitdf$Unadjusted, splitdf$Adjusted)

#Change the ordering for the groups
h2forplot$covar_name <- factor(h2forplot$covar_name, 
                                levels = c(setdiff(unique(h2forplot$covar_name), "MultipleAdj"), "MultipleAdj"))

#Forest plot for the observational and PRS estimate
ggforestplot::forestplot(
    df = h2forplot,
    name = covar_name,
    estimate = h2,
    se = se,
    pvalue = pval,
    xlab = "GCTA-GREML h2 estimate",
    ylab = "h2 Adjustment model",
    colour = covar_name,
    psignif = 0.0000001 # Set as small number so don't get hollow points on plots
) +
    ggforce::facet_col(
        facets = ~bug,
        scales = "free_y"
    ) +
    scale_color_discrete() +
  guides(color = "none")



```



```{r, Fig9a, out.height="70%", out.width="90%", fig.width=15, fig.height=10, fig.align='center', fig.cap="The forest plot of two examplar relationships are plotted with the two scatter plots of beta coefficient correlation between the covariate sumstat and microbiome sumstat. Both the results from the FGFP sumstat correlation and the indpendent MiBioGen sumstat are plotted"}

## Figure 9: Scatter and forest plots from our analyses pipeline for two microbiome-covariate relationships with strong evidence of genetic covariation

# Lets add in all the results for the two bugs where we saw strong evidence of an association with BMI

traitsforplots <- data.frame(matrix(ncol=3))

traitsforplots[1,] <- c("yengo_bmi", "G_unclassified_O_Clostridiales_RNT", "order.Clostridiales.id.1863")
traitsforplots[2,] <- c("Serum_uric_acid_levels", "Div_Shannon_RNT", "shannon")

plots <- list()

for(i in 1:nrow(traitsforplots)){

covariate_name <- traitsforplots[i,1]
covariates_name_clean <- filter(naming_map, prs == covariate_name)[["covar_name"]]
mt_fgfp <- traitsforplots[i,2] 
mt_mbg <- traitsforplots[i,3]

data4scatter <- list()
data4scatter[["data_fgfp"]] <- harm_data_all[[covariate_name]][[mt_fgfp]]
data4scatter[["data_mbg"]] <- harm_data_all_mbg[[covariate_name]][[mt_mbg]]

#Add in a dir agreement

for(dataname in names(data4scatter)){
  
  dir <- filter(lm_out, bug == mt_fgfp & covar == covariate_name)[["fgfp_estimate"]] %>% sign()
  
  data4scatter[[dataname]] <- mutate(data4scatter[[dataname]],
                     BetaDirAgreement = ifelse(sign(beta.exposure)*sign(beta.outcome) == dir, "Consistent Dir", "Inconsistent Dir")) %>% filter(!is.na(BetaDirAgreement))
}



for(dataname in names(data4scatter)){
  if(dataname == "data_fgfp"){
    mt <- mt_fgfp
    d <- "FGFP"
  } else {
    mt <- mt_mbg
    d <- "Replication"
  }
  lm <- lm(beta.exposure ~ beta.outcome, data = data4scatter[[dataname]])
  lm_p <- summary(lm)$coefficients[2, 4] %>% signif(2)
  ivw <- lm(beta.exposure ~ beta.outcome, data = data4scatter[[dataname]], weights = data4scatter[[dataname]]$weights)
  ivw_p <- summary(ivw)$coefficients[2, 4] %>% signif(2)
  
plots[[mt_fgfp]][["scatter"]][[dataname]] <- ggplot(data4scatter[[dataname]], aes(beta.outcome, beta.exposure)) +
    geom_errorbar(aes(ymax = beta.exposure + 1.96 * se.exposure, ymin = beta.exposure - 1.96 * se.exposure), 
                  width = 0, alpha = 0.5) +  # Semi-transparent error bars
    geom_errorbar(aes(xmax = beta.outcome + 1.96 * se.outcome, xmin = beta.outcome - 1.96 * se.outcome), 
                  width = 0, alpha = 0.5) +
    geom_point(shape = 21, color = "black", fill = "steelblue", size = 3) + 
    geom_abline(
      slope = coef(lm)[2], 
      intercept = coef(lm)[1], 
      color = "seagreen",
      size = 1
    ) +
    geom_abline(
      slope = 0, 
      intercept = 0, 
      color = "red",
      size = .5,
      linetype = "dashed"
    )  +
    annotate("text", x = min(data4scatter[[dataname]]$beta.outcome - 1.96 * data4scatter[[dataname]]$se.outcome), y = min(na.omit(data4scatter[[dataname]]$beta.exposure - 1.96 * data4scatter[[dataname]]$se.exposure)),
             label = paste("lm pval=", lm_p,"\nIVW pval =", ivw_p), color = "black", hjust = 0, size = 4) +
labs(title = paste(d, "GWAS Beta Correlation \nfor", covariates_name_clean, "SNPs"),
         y = paste(mt, "SNP Betas"),
         x = paste(covariates_name_clean, "SNP Betas")) +
    theme(
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
      axis.title = element_text(size = 12, face = "bold"),
      axis.text = element_text(size = 10),
      plot.margin = unit(c(1, 1, 1, 1), "lines")
    )

plots[[mt_fgfp]][["vol1"]][[dataname]] <- ggplot(data4scatter[[dataname]], aes(x = beta.outcome, y = -log10(pval.outcome), col = BetaDirAgreement)) +
    geom_point(size = 2, alpha = 0.8) +
    geom_hline(yintercept = -log10(5e-8), col = "red", linetype = "dashed", size = 1) +
    scale_color_manual(
      values = c("Consistent Dir" = "green3", "Inconsistent Dir" = "firebrick"),
      name = "SNP Beta direction Agreement"
    ) +
    labs(
      title = paste("Volcano Plot of", covariates_name_clean , "SNPs coloured by beta directionality agreement\nwith" , mt, "GWAS"),
      subtitle = "Red dashed line represents genome-wide significance threshold (p < 5e-8)",
      x = "Effect Size (Beta)",
      y = expression(-log[10](p-value))
    ) +
    # Minimal theme with adjustments
    theme_minimal(base_size = 14) +
    theme(
      legend.position = "top",
      legend.title = element_text(size = 12),
      legend.text = element_text(size = 10),
      plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5),
      axis.title = element_text(size = 14),
      axis.text = element_text(size = 12)
    )

  plots[[mt_fgfp]][["vol2"]][[dataname]] <- ggplot(data4scatter[[dataname]], aes(x = beta.exposure, y = -log10(pval.exposure), col = BetaDirAgreement)) +
    geom_point(size = 2, alpha = 0.8) +
    scale_color_manual(
      values = c("Consistent Dir" = "green3", "Inconsistent Dir" = "firebrick"),
      name = paste("Beta direction Agreement with", covariates_name_clean, "GWAS")
    ) +
    labs(
      title = paste("Volcano Plot of", covariates_name_clean, "SNPs from", mt, "GWAS\ncoloured by beta directionality agreement with" , covariates_name_clean, "GWAS"),
      x = "Effect Size (Beta)",
      y = expression(-log[10](p-value))
    ) +
    # Minimal theme with adjustments
    theme_minimal(base_size = 14) +
    theme(
      legend.position = "top",
      legend.title = element_text(size = 12),
      legend.text = element_text(size = 10),
      plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5),
      axis.title = element_text(size = 14),
      axis.text = element_text(size = 12)
    )

}

plots[[mt_fgfp]][["forestplot"]] <- ggforestplot::forestplot(
  df = filter(obsest_prsest_long, 
              (mt == paste0(mt_fgfp, "Res") & prs == covariate_name)),
  name = mt,
  estimate = estimate,
  se = std.error,
  pvalue = p.value,
  colour = type,
  xlab = "SD increase in Rank normal transformed Microbial trait per 1-SD increase in polygenic loading of the covariate / the measure covariate in FGFP",
  title = ("PRS and Observational Forest plot from FGFP Analysis")) +
  ggforce::facet_row(
    facets = ~ covar_name,
    scales = "free_y"
  ) +
  # Apply theme adjustments
  theme_classic() +
  theme(
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),  # Title style
    axis.title.x = element_text(size = 12, face = "bold"),  # X-axis title style
    axis.text.x = element_text(size = 10),  # X-axis tick label style
    strip.text = element_text(size = 12, face = "bold"),  # Facet label style
    plot.margin = unit(c(1, 1, 1, 1), "lines")  # Adjust plot margins
  )

}

plots[["G_unclassified_O_Clostridiales_RNT"]][["forestplot"]] / (plots[["G_unclassified_O_Clostridiales_RNT"]][["scatter"]][["data_fgfp"]] + plots[["G_unclassified_O_Clostridiales_RNT"]][["scatter"]][["data_mbg"]])
```

```{r, Fig9b, out.height="70%", out.width="90%", fig.width=15, fig.height=10, fig.align='center', fig.cap="The forest plot of two examplar relationships are plotted with the two scatter plots of beta coefficient correlation between the covariate sumstat and microbiome sumstat. Both the results from the FGFP sumstat correlation and the indpendent MiBioGen sumstat are plotted", eval=F}
(plots[["Div_Shannon_RNT"]][["scatter"]][["data_fgfp"]] + plots[["Div_Shannon_RNT"]][["scatter"]][["data_mbg"]])
```


\newpage



```{r Fig10, out.height="70%", out.width="90%", fig.width=15, fig.height=10, fig.align='center', fig.cap="", eval=F}

## Figure 10: Statistical reduandancy in Microbiome GWAS designs as highlighted by two microbiome similar Microbiome traits F_Firmicutes and F_Firmicutes__C_Clostridia__O_Clostridiales


traitsforplots <- data.frame(matrix(ncol=3))

traitsforplots[1,] <- c("yengo_bmi", "G_unclassified_O_Clostridiales_RNT", "order.Clostridiales.id.1863")
traitsforplots[2,] <- c("yengo_bmi", "G_unclassified_P_Firmicutes_RNT", "phylum.Firmicutes.id.1672")

plots2 <- list()

for(i in 1:nrow(traitsforplots)){

covariate_name <- traitsforplots[i,1]
covariates_name_clean <- filter(naming_map, prs == covariate_name)[["covar_name"]]
mt_fgfp <- traitsforplots[i,2] 
mt_mbg <- traitsforplots[i,3]

data4scatter <- list()
data4scatter[["data_fgfp"]] <- harm_data_all[[covariate_name]][[mt_fgfp]]
data4scatter[["data_mbg"]] <- harm_data_all_mbg[[covariate_name]][[mt_mbg]]

#Add in a dir agreement

for(dataname in names(data4scatter)){
  
  dir <- filter(lm_out, bug == mt_fgfp & covar == covariate_name)[["estimate"]] %>% sign()
  
  data4scatter[[dataname]] <- mutate(data4scatter[[dataname]],
                     BetaDirAgreement = ifelse(sign(beta.exposure)*sign(beta.outcome) == dir, "Consistent Dir", "Inconsistent Dir")) %>% filter(!is.na(BetaDirAgreement))
}



for(dataname in names(data4scatter)){
  if(dataname == "data_fgfp"){
    mt <- mt_fgfp
    d <- "FGFP"
  } else {
    mt <- mt_mbg
    d <- "MiBioGen_EURnofgfp"
  }
  lm <- lm(beta.exposure ~ beta.outcome, data = data4scatter[[dataname]])
  lm_p <- summary(lm)$coefficients[2, 4] %>% signif(2)
  ivw <- lm(beta.exposure ~ beta.outcome, data = data4scatter[[dataname]], weights = data4scatter[[dataname]]$weights)
  ivw_p <- summary(ivw)$coefficients[2, 4] %>% signif(2)
  
plots2[[mt_fgfp]][["scatter"]][[dataname]] <- ggplot(data4scatter[[dataname]], aes(beta.outcome, beta.exposure)) +
    geom_errorbar(aes(ymax = beta.exposure + 1.96 * se.exposure, ymin = beta.exposure - 1.96 * se.exposure), 
                  width = 0, alpha = 0.5) +  # Semi-transparent error bars
    geom_errorbar(aes(xmax = beta.outcome + 1.96 * se.outcome, xmin = beta.outcome - 1.96 * se.outcome), 
                  width = 0, alpha = 0.5) +
    geom_point(shape = 21, color = "black", fill = "steelblue", size = 3) + 
    geom_abline(
      slope = coef(lm)[2], 
      intercept = coef(lm)[1], 
      color = "seagreen",
      size = 1
    ) +
    geom_abline(
      slope = 0, 
      intercept = 0, 
      color = "red",
      size = .5,
      linetype = "dashed"
    )  +
    annotate("text", x = min(data4scatter[[dataname]]$beta.outcome - 1.96 * data4scatter[[dataname]]$se.outcome), y = min(na.omit(data4scatter[[dataname]]$beta.exposure - 1.96 * data4scatter[[dataname]]$se.exposure)),
             label = paste("lm pval=", lm_p,"\nIVW pval =", ivw_p), color = "black", hjust = 0, size = 4) +
labs(title = paste(d, "GWAS Beta Correlation \nfor", covariates_name_clean, "SNPs"),
         y = paste(mt, "SNP Betas"),
         x = paste(covariates_name_clean, "SNP Betas")) +
    theme(
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
      axis.title = element_text(size = 12, face = "bold"),
      axis.text = element_text(size = 10),
      plot.margin = unit(c(1, 1, 1, 1), "lines")
    )
}
}

(plots2[["G_unclassified_O_Clostridiales_RNT"]][["scatter"]][["data_fgfp"]] +
plots2[["G_unclassified_P_Firmicutes_RNT"]][["scatter"]][["data_fgfp"]]) /
(plots2[["G_unclassified_O_Clostridiales_RNT"]][["scatter"]][["data_mbg"]]  + plots2[["G_unclassified_P_Firmicutes_RNT"]][["scatter"]][["data_mbg"]])
```




```{r, out.height="80%", out.width="90%", fig.width=20, fig.height=15, fig.align='center', fig.cap="Plots of two example relationships (G\\_Aestuariispira / triglycerides \\& G\\_unclassified\\_O\\_Clostridiales / Uric acid) between the beta coefficients of the covariate SNP instrument and the microbiome GWAS beta coefficients. The plots show results from previous regressions (A) and the correlation of the covariate instrument betas between the covariate GWAS and the microbiome GWAS.", eval = F}
## Figure 9: Correlation of the covariate SNP instrument beta coefficents between covariate and microbiome GWAS for example microboime-covariate relationships

#This has been removed as better to visualise this with our two BMI examples where we have strong evidence

#Exemplar relationships to highlight
#G_Aestuariispira and triglycerides
#G_unclassified_O_Clostridiales and Uric acid

trait1 <- "Serum_uric_acid_levels"
trait2 <- "Div_Shannon_RNT"

# Fit linear model and extract p-value
model <- lm(beta.outcome ~ beta.exposure, data = harm_data_all[[trait1]][[trait2]])
p_value <- summary(model)$coefficients[2, 4] %>% format(scientific = TRUE, digits = 3)

scatter1 <- ggplot(harm_data_all[[trait1]][[trait2]], aes(beta.exposure, beta.outcome)) +
    geom_errorbar(aes(ymax = beta.outcome + 1.96 * se.outcome, ymin = beta.outcome - 1.96 * se.outcome), 
                  width = 0, alpha = 0.5) +  # Semi-transparent error bars
    geom_errorbar(aes(xmax = beta.exposure + 1.96 * se.exposure, xmin = beta.exposure - 1.96 * se.exposure), 
                  width = 0, alpha = 0.5) +
  coord_fixed() +
    geom_point(shape = 21, color = "black", fill = "steelblue", size = 3) +  # Points with black outline
    geom_smooth(method = "lm", color = "firebrick", linetype = "solid", size = 1) +
    labs(title = "Beta Coefficient Correlation for Triglyceride SNPs\nbetween G_Aestuariispira GWAS and Triglycerides GWAS",
         x = "Triglyceride SNP Betas from G_Aestuariispira GWAS",
         y = "Triglyceride SNP Betas from Triglycerides GWAS") +
    # Annotate p-value on the plot
    annotate("text", x = Inf, y = Inf, label = paste("Slope p-value:", p_value), 
             hjust = 1.1, vjust = 1.1, size = 3, color = "black") +
    theme_classic() +
    theme(
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(size = 10),
        plot.margin = unit(c(1, 1, 1, 1), "lines")
    )




model <- lm(beta.outcome ~ beta.exposure, data = harm_data_all[["Serum_uric_acid_levels"]][["G_unclassified_O_Clostridiales_RNT"]])
p_value <- summary(model)$coefficients[2, 4] %>% format(scientific = TRUE, digits = 3)

scatter2 <- ggplot(harm_data_all[["Serum_uric_acid_levels"]][["G_unclassified_O_Clostridiales_RNT"]], aes(beta.exposure, beta.outcome)) +
    geom_errorbar(aes(ymax = beta.outcome + 1.96 * se.outcome, ymin = beta.outcome - 1.96 * se.outcome), 
                  width = 0, alpha = 0.5) +  # Semi-transparent error bars
    geom_errorbar(aes(xmax = beta.exposure + 1.96 * se.exposure, xmin = beta.exposure - 1.96 * se.exposure), 
                  width = 0, alpha = 0.5) +
  coord_fixed() +  
  geom_point(shape = 21, color = "black", fill = "steelblue", size = 3) +  # Points with black outline
    geom_smooth(method = "lm", color = "firebrick", linetype = "solid", size = 1) +
    labs(title = "Beta Coefficient Correlation for Uric Acid SNPs\nbetween G_unclassified_O_Clostridiales GWAS and Uric Acid GWAS",
         x = "Uric Acid SNP Betas from G_unclassified_O_Clostridiales GWAS",
         y = "Uric Acid SNP Betas from Uric Acid GWAS") +
    # Annotate p-value on the plot
    annotate("text", x = Inf, y = Inf, label = paste("Slope p-value:", p_value), 
             hjust = 1.1, vjust = 1.1, size = 3, color = "black") +
    theme_classic() +
    theme(
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(size = 10),
        plot.margin = unit(c(1, 1, 1, 1), "lines")
    )


forestplot <- ggforestplot::forestplot(
  df = filter(obsest_prsest_long, 
              (mt == "G_Aestuariispira_RNTRes" & prs == "triglycerides") | 
              (mt == "G_unclassified_O_Clostridiales_RNTRes" & prs == "Serum_uric_acid_levels")),
  name = mt,
  estimate = estimate,
  se = std.error,
  pvalue = p.value,
  colour = type,
  xlab = "SD increase in Rank normal transformed Microbial trait per 1-SD increase in polygenic loading of the covariate / the measure covariate in FGFP",
  title = ("PRS and Observational Forest plot")) +
  ggforce::facet_row(
    facets = ~covar_name,
    scales = "free_y"
  ) +
  # Apply theme adjustments
  theme_classic() +
  theme(
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),  # Title style
    axis.title.x = element_text(size = 12, face = "bold"),  # X-axis title style
    axis.text.x = element_text(size = 10),  # X-axis tick label style
    strip.text = element_text(size = 12, face = "bold"),  # Facet label style
    plot.margin = unit(c(1, 1, 1, 1), "lines")  # Adjust plot margins
  )

forestplot / (scatter1 + scatter2) + 
  plot_layout(heights = c(1, 3)) + plot_annotation(tag_levels = "A")


```



```{r,out.height="70%", out.width="90%", fig.width=15, fig.height=20, fig.align='center', fig.cap="All GWAS beta coefficent correlations for our candidate relationships plotted with their PRS and observational regression estimate.", eval=FALSE}

## Figure 10: Forest plot of observational and PRS beta coefficents, alongside the beta of the correlation of GWAS beta coefficents for all microbiome-covariate candidate relationships

#This has been removed as it doesn't really show anything - all of it is covered in the next plot

#Forest plot for the observational and PRS estimate
ggforestplot::forestplot(
  df = obsest_prest_betacor_long,
  name = mt,
  estimate = estimate,
  se = std.error,
  pvalue = p.value,
  colour = type,
  xlab = "Beta from Observation / PRS / Beta_GWAS regressions",
  title = "Candidate Covariate-Microbiome relationships") +
  ggforce::facet_col(
    facets = ~covar_name,
    scales = "free_y"
  )
```



```{r, eval=F}

#Volcano plots if ever wanted to use this

#Lets look at the volcano plots of our interesting assciations

#Make list for storing plots
plots <- list()

for(i in 1:nrow(tofollow)){
  #Covar volcano plot
  volbug <- tofollow$mbgbugs[i]
  volcovar <- tofollow$covar[i]
  covarname_clean <- naming_map$covar_name[naming_map$prs == volcovar]
  
  mbg_dir <- filter(lm_out_mbg, mbgbugs == volbug & covar == volcovar)[["estimate"]] %>% sign()
  
  data4vol <- mutate(harm_data_all_mbg[[volcovar]][[volbug]],
                     BetaDirAgreement = ifelse(sign(beta.exposure)*sign(beta.outcome) == mbg_dir, "Consistent Dir", "Inconsistent Dir")) %>% filter(!is.na(BetaDirAgreement))
  
  ### First a scatter of the MBG SNPs
  # We want to compute the IVW and linear regression so this can be displayed on the plot
  
  lm <- lm(beta.exposure ~ beta.outcome, data = data4vol)
  lm_p <- summary(lm)$coefficients[2, 4] %>% round(3)
  ivw <- lm(beta.exposure ~ beta.outcome, data = data4vol, weights = data4vol$weights)
  ivw_p <- summary(ivw)$coefficients[2, 4] %>% round(3)
  
  
  
  
  plots[[covarname_clean]][[volbug]][["scatter"]] <- ggplot(data4vol, aes(beta.outcome, beta.exposure)) +
    geom_errorbar(aes(ymax = beta.exposure + 1.96 * se.exposure, ymin = beta.exposure - 1.96 * se.exposure), 
                  width = 0, alpha = 0.5) +  # Semi-transparent error bars
    geom_errorbar(aes(xmax = beta.outcome + 1.96 * se.outcome, xmin = beta.outcome - 1.96 * se.outcome), 
                  width = 0, alpha = 0.5) +
    geom_point(shape = 21, color = "black", fill = "steelblue", size = 3) + 
    geom_abline(
      slope = coef(lm)[2], 
      intercept = coef(lm)[1], 
      color = "seagreen",
      size = 1
    ) +
    geom_abline(
      slope = 0, 
      intercept = 0, 
      color = "red",
      size = .5,
      linetype = "dashed"
    )  +
    annotate("text", x = min(data4vol$beta.outcome - 1.96 * data4vol$se.outcome), y = min(data4vol$beta.exposure - 1.96 * data4vol$se.exposure),
             label = paste("lm pval=", lm_p,"\nIVW pval =", ivw_p), color = "black", hjust = 0, size = 4) +
    labs(title = paste("Correlation of", covarname_clean, "SNPs between", covarname_clean, "GWAS and\nMiBioGen_EURnofgfp", volbug, "bug GWAS"),
         x = paste(covarname_clean, "GWAS Betas"),
         y = paste(volbug, "GWAS Betas")) +
    theme(
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
      axis.title = element_text(size = 12, face = "bold"),
      axis.text = element_text(size = 10),
      plot.margin = unit(c(1, 1, 1, 1), "lines")
    )
  
  plots[[covarname_clean]][[volbug]][["vol1"]] <- ggplot(data4vol, aes(x = beta.outcome, y = -log10(pval.outcome), col = BetaDirAgreement)) +
    geom_point(size = 2, alpha = 0.8) +
    geom_hline(yintercept = -log10(5e-8), col = "red", linetype = "dashed", size = 1) +
    scale_color_manual(
      values = c("Consistent Dir" = "green3", "Inconsistent Dir" = "firebrick"),
      name = "Beta direction Agreement with Microbiome GWAS"
    ) +
    labs(
      title = paste("Volcano Plot of", covarname_clean, "SNPs coloured by beta directionality agreement\nwith" , volbug, "GWAS"),
      subtitle = "Red dashed line represents genome-wide significance threshold (p < 5e-8)",
      x = "Effect Size (Beta)",
      y = expression(-log[10](p-value))
    ) +
    # Minimal theme with adjustments
    theme_minimal(base_size = 14) +
    theme(
      legend.position = "top",
      legend.title = element_text(size = 12),
      legend.text = element_text(size = 10),
      plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5),
      axis.title = element_text(size = 14),
      axis.text = element_text(size = 12)
    )
  
  plots[[covarname_clean]][[volbug]][["vol2"]] <- ggplot(data4vol, aes(x = beta.exposure, y = -log10(pval.exposure), col = BetaDirAgreement)) +
    geom_point(size = 2, alpha = 0.8) +
    scale_color_manual(
      values = c("Consistent Dir" = "green3", "Inconsistent Dir" = "firebrick"),
      name = paste("Beta direction Agreement with", covarname_clean, "GWAS")
    ) +
    labs(
      title = paste("Volcano Plot of", covarname_clean, "SNPs from", volbug, "GWAS\ncoloured by beta directionality agreement with" , covarname_clean, "GWAS"),
      x = "Effect Size (Beta)",
      y = expression(-log[10](p-value))
    ) +
    # Minimal theme with adjustments
    theme_minimal(base_size = 14) +
    theme(
      legend.position = "top",
      legend.title = element_text(size = 12),
      legend.text = element_text(size = 10),
      plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5),
      axis.title = element_text(size = 14),
      axis.text = element_text(size = 12)
    )
  
  plots[[covarname_clean]][[volbug]][["all"]] <- plots[[covarname_clean]][[volbug]][["scatter"]] + (plots[[covarname_clean]][[volbug]][["vol1"]] / plots[[covarname_clean]][[volbug]][["vol2"]])
}


#Lets look at all of these
for(i in 1:length(plots)){
  for(j in 1:length(plots[[i]])){
    plots[[i]][[j]][["all"]] %>% print()
  }
}
```